<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>乐优商城--秒杀页面</title>
	<link rel="icon" href="/assets/img/favicon.ico">


    <link rel="stylesheet" type="text/css" href="css/webbase.css" />
    <link rel="stylesheet" type="text/css" href="css/widget-jquery.autocomplete.css" />
    <link rel="stylesheet" type="text/css" href="css/pages-seckill-index.css" />
</head>

<body>

	<!-- 头部栏位 -->
	<!--页面顶部，由js动态加载-->
	<script type="text/javascript" src="plugins/jquery/jquery.min.js"></script>
	<div id="nav-bottom"></div>
    <script type="text/javascript">$("#nav-bottom").load("top.html");</script>
	

<script type="text/javascript" src="js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript">
$(function(){
	$("#service").hover(function(){
		$(".service").show();
	},function(){
		$(".service").hide();
	});
	$("#shopcar").hover(function(){
		$("#shopcarlist").show();
	},function(){
		$("#shopcarlist").hide();
	});

})
</script>
<script type="text/javascript" src="js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="js/widget/jquery.autocomplete.js"></script>
<script type="text/javascript" src="js/widget/nav.js"></script>
<script type="text/javascript" src="js/pages/seckill-index.js"></script>
<script>
	   $(function(){
		   $("#code").hover(function(){
			   $(".erweima").show();
		   },function(){
			   $(".erweima").hide();
		   });
	   })
	</script>
	<div class="py-container index">
		<!--banner-->
		<div class="banner">
			<img src="img/_/banner.png" class="img-responsive" alt="">
		</div>

		<div class="cd-top">
			<div class="top">
				<img src="img/_/gotop.png" />
				<b>TOP</b>
			</div>
			<div class="code" id="code">
				<span><img src="img/_/code.png"/></span>
			</div>
			<div class="erweima">
				<img src="img/_/erweima.jpg" alt="">
				<s></s>
			</div>
		</div>
	</div>

	<div id="seckillApp">
		<!--商品列表-->
		<div class="goods-list">
			<ul class="seckill" id="seckill">
				<li class="seckill-item" v-for="(item,index) in items" :key="index">
					<a class="pic" :href="'/seckill-item.html?id=' + item.id" target="_self">
						<img :src="item.smallPic" alt=''  >
					</a>
					<div class="intro"><span>{{item.title}}</span></div>
					<div class='price'><b class='sec-price'>￥{{ly.formatPrice(item.costPrice)}}</b><b class='ever-price'>{{ly.formatPrice(item.price)}}</b></div>
					<div class='num'>
						<div>已售{{((item.num-item.stockCount)/item.num)*100}}%</div>
						<div class='progress'>
							<div class='sui-progress progress-danger'><span style='width: 70%;' class='bar'></span></div>
						</div>
						<div>剩余<b class='owned'>{{item.stockCount}}</b>件</div>
					</div>
					<a class='sui-btn btn-block btn-buy' :href="'/seckill-item.html?id=' + item.id" target='_self'>立即抢购</a>
				</li>



			</ul>
		</div>
	</div>
	<!--seckillApp-->
	<script src="./js/vue/vue.js"></script>
	<script src="./js/axios.min.js"></script>
	<script src="./js/common.js"></script>
	<script type="text/javascript">
        var cartVm = new Vue({

            el: "#seckillApp",
            data: {
                ly,
                items:[],
                carts: [],
                selected: [],
                check: true,
                preferential:{},
                totalNum:0,
                totalMoney:0
            },
            created(){
                //登录
                ly.http.get("/seckill/seckill/goods/list").then(({data}) => {
                    this.items = data;
                    console.log(data);
                    //this.selected = this.carts;
                    //console.log(res);
                })
            },
            watch:{
                check(newVal){
                    if(newVal){
                        this.selected = this.carts;
                    }else {
                        this.selected = [];
                    }
                },
                selected: {
                    deep: true,
                    handler() {
                        this.sumPreferential();
                    }
                }
            },
            computed:{ /**/
                total(){/*计算选择数量*/
                    return this.selected.reduce((c1, c2)=> c1 + c2.num, 0);
                },
                totalPrice(){/*计算优惠后价格*/

                    return this.selected.reduce((c1, c2)=> c1 + c2.num * c2.price, 0);
                }
            },
            methods:{
                count(){
                    this.totalNum=0;  //数量
                    this.totalMoney=0; //金额
                    //循环购物车
                    for(let i=0;i<this.selected.length;i++){
                        //判断如果选中，数量和金额累加
                        this.totalNum+= this.selected[i].item.num;
                        this.totalMoney+= this.selected[i].item.price;

                    }
                    //计算优惠金额
                    ly.http.post("/cart/cartSum").then(response => {
                        this.preferential= response.data.preferential;
                        this.totalMoney=this.totalMoney-this.preferential;//最后的总金额
                    });
                },
                sumPreferential(){//计算优惠价格
                    console.log(this.selected[0].num);
                    ly.http.post("/cart/cartSum", this.selected).then((rep)=>{
                        console.log(rep.data);
                        this.preferential = rep.data.preferential;
                    });
                },
                toOrder(){
                    ly.verify().then(res=>{
                        //登录
                        ly.store.set("LY_SELECTED", this.selected);
                        window.location = "http://www.leyou.com/getOrderInfo.html";
                    }).catch(()=>{
                        //未登录
                        window.location = "http://www.leyou.com/login.html?returnUrl=http://www.leyou.com/getOrderInfo.html";
                    })
                },
                incr(cart){//增加数量
                    cart.num++;
                    this.sumPreferential();
                    ly.verify().then(res=>{
                        //登录
                        ly.http.put("/cart", {skuId: cart.skuId, num: cart.num});
                    }).catch(()=>{
                        //未登录 购物车查询
                        ly.store.set("LY_CART", this.carts);
                    })

                },
                decr(cart){//删除数量
                    if(cart.num > 1){
                        cart.num--;
                        this.sumPreferential();
                    }
                    ly.verify().then(res=>{
                        //登录
                        ly.http.put("/cart", {skuId: cart.skuId, num: cart.num});
                    }).catch(()=>{
                        //未登录
                        ly.store.set("LY_CART", this.carts);
                    })
                },
                deleteCart(index){//移除购物车
                    ly.verify().then(res=>{
                        //登录
                        ly.http.delete("/cart/" + this.carts[index].skuId).then(() => this.carts.splice(index, 1));
                    }).catch(()=>{
                        //未登录
                        this.carts.splice(index, 1);/*从该下标开始删除一个*/
                        ly.store.set("LY_CART", this.carts);
                    })
                }
            },
            components: {
                shortcut: () => import("/js/pages/shortcut.js")
            }
        })
	</script>

	<!-- 底部栏位 -->
	<!--页面底部，由js动态加载-->
	<div class="clearfix footer"></div>
	<script type="text/javascript">$(".footer").load("foot.html");</script>
	<!--页面底部END-->


</body>




</html>